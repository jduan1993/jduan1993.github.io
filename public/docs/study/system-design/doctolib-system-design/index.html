<!DOCTYPE html>
<html lang="zh" dir="ltr">
<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="以下给出一个面向生产环境、可扩展且高可用的微服务架构设计方案，重点关注“患者搜索与预约”这一日历（Calendar）功能的重构。方案会针对各子系统划分、技术选型、可扩展性、容错、数据一致性、多区域部署等方面进行说明，并针对每个组件选用的语言或技术做出理由说明。


  1. 非功能需求与业务规模
  #



规模要求

患者数量：50M
从业者数量：500K
并发搜索：700 次/秒
并发预约（booking）：90 次/秒



可扩展性

支持快速上线新国家/地区
支持水平扩展（水平扩容实例）



高可用、容错、降级

单点故障需避免
任一组件出故障时，应保证核心功能（如查询缓存、只读搜索）尽可能可用，写操作可做限流或降级提示



数据一致性

预约（Booking）流程需强一致或可接受的约束下的弱一致（依实践设计），但冲突需被正确检测并妥善处理。
搜索结果可采用近实时（Eventual Consistency）方式更新。



响应时延

搜索响应：百毫秒级
预约确认：次秒级体验



安全与合规

涉及医疗数据或个人信息，需符合相关法规（如 GDPR、HIPAA 等，视具体国家要求）
传输加密（TLS），存储加密，细粒度权限控制



可观察性

全链路追踪、日志、指标监控、告警



自动化运维 / CI/CD

基于容器化与基础设施即代码（IaC），实现流水线自动化部署、滚动升级、灰度发布





  2. 总体架构概览
  #

采用微服务架构 &#43; API Gateway &#43; 服务网格（可选） &#43; 多区域部署 &#43; 弹性伸缩。核心组件：

API Gateway：统一入口，做认证鉴权、限流、路由。
Auth 服务：处理登录、认证、授权（OAuth2 / JWT）。
User 服务：管理患者与从业者的 Profile 信息。
Search 服务：负责处理按位置、专科、可用时段等条件的搜索请求；依赖搜索索引（Elasticsearch）。
Availability 服务：维护和计算从业者可预约时段（working hours &#43; 例外情况 &#43; 节假日 &#43; 已有预约冲突）。
Booking 服务：处理预约创建、修改、取消事务，确保并发安全与一致性。
Notification 服务：异步发送邮件/SMS/Push 推送（预约确认、提醒、变更通知）。
Analytics / Monitoring 服务（或外部）：收集日志、指标，用于监控与数据分析。
Payment / Billing 服务（如需付费预约，可选）。
配置与管理服务：管理多国家/地区配置（时区、节假日规则、语言、合规设置等）。
异步消息平台（如 Kafka）：用于事件流（Event Bus），实现微服务间的解耦异步通信，如预约事件、索引更新、通知触发等。
缓存层：Redis，用于热点数据、短期缓存、分布式锁等。
数据库：关系型数据库（PostgreSQL/CockroachDB/Vitess&#43;MySQL/Aurora 等）；可根据跨区域需求选择分布式SQL（如 CockroachDB）或各区域独立数据库并做异步复制。
搜索引擎：Elasticsearch 或 OpenSearch，用于地理位置与属性过滤、可用性初筛索引等。
基础设施与部署：容器化（Docker）、Kubernetes（EKS/GKE/AKS 或自托管 K8s）、Terraform/CloudFormation 管理资源，多区域集群部署。

下面分模块详细阐述，并说明选型理由。">
<meta name="theme-color" media="(prefers-color-scheme: light)" content="#ffffff">
<meta name="theme-color" media="(prefers-color-scheme: dark)" content="#343a40">
<meta name="color-scheme" content="light dark"><meta property="og:url" content="http://localhost:1313/docs/study/system-design/doctolib-system-design/">
  <meta property="og:site_name" content="君宝的笔记">
  <meta property="og:title" content="Doctolib 系统设计">
  <meta property="og:description" content="以下给出一个面向生产环境、可扩展且高可用的微服务架构设计方案，重点关注“患者搜索与预约”这一日历（Calendar）功能的重构。方案会针对各子系统划分、技术选型、可扩展性、容错、数据一致性、多区域部署等方面进行说明，并针对每个组件选用的语言或技术做出理由说明。
1. 非功能需求与业务规模#规模要求
患者数量：50M 从业者数量：500K 并发搜索：700 次/秒 并发预约（booking）：90 次/秒 可扩展性
支持快速上线新国家/地区 支持水平扩展（水平扩容实例） 高可用、容错、降级
单点故障需避免 任一组件出故障时，应保证核心功能（如查询缓存、只读搜索）尽可能可用，写操作可做限流或降级提示 数据一致性
预约（Booking）流程需强一致或可接受的约束下的弱一致（依实践设计），但冲突需被正确检测并妥善处理。 搜索结果可采用近实时（Eventual Consistency）方式更新。 响应时延
搜索响应：百毫秒级 预约确认：次秒级体验 安全与合规
涉及医疗数据或个人信息，需符合相关法规（如 GDPR、HIPAA 等，视具体国家要求） 传输加密（TLS），存储加密，细粒度权限控制 可观察性
全链路追踪、日志、指标监控、告警 自动化运维 / CI/CD
基于容器化与基础设施即代码（IaC），实现流水线自动化部署、滚动升级、灰度发布 2. 总体架构概览#采用微服务架构 &#43; API Gateway &#43; 服务网格（可选） &#43; 多区域部署 &#43; 弹性伸缩。核心组件：
API Gateway：统一入口，做认证鉴权、限流、路由。 Auth 服务：处理登录、认证、授权（OAuth2 / JWT）。 User 服务：管理患者与从业者的 Profile 信息。 Search 服务：负责处理按位置、专科、可用时段等条件的搜索请求；依赖搜索索引（Elasticsearch）。 Availability 服务：维护和计算从业者可预约时段（working hours &#43; 例外情况 &#43; 节假日 &#43; 已有预约冲突）。 Booking 服务：处理预约创建、修改、取消事务，确保并发安全与一致性。 Notification 服务：异步发送邮件/SMS/Push 推送（预约确认、提醒、变更通知）。 Analytics / Monitoring 服务（或外部）：收集日志、指标，用于监控与数据分析。 Payment / Billing 服务（如需付费预约，可选）。 配置与管理服务：管理多国家/地区配置（时区、节假日规则、语言、合规设置等）。 异步消息平台（如 Kafka）：用于事件流（Event Bus），实现微服务间的解耦异步通信，如预约事件、索引更新、通知触发等。 缓存层：Redis，用于热点数据、短期缓存、分布式锁等。 数据库：关系型数据库（PostgreSQL/CockroachDB/Vitess&#43;MySQL/Aurora 等）；可根据跨区域需求选择分布式SQL（如 CockroachDB）或各区域独立数据库并做异步复制。 搜索引擎：Elasticsearch 或 OpenSearch，用于地理位置与属性过滤、可用性初筛索引等。 基础设施与部署：容器化（Docker）、Kubernetes（EKS/GKE/AKS 或自托管 K8s）、Terraform/CloudFormation 管理资源，多区域集群部署。 下面分模块详细阐述，并说明选型理由。">
  <meta property="og:locale" content="zh">
  <meta property="og:type" content="article">
    <meta property="article:section" content="docs">
    <meta property="article:modified_time" content="2025-06-24T15:30:39+08:00">
<title>Doctolib 系统设计 | 君宝的笔记</title>
<link rel="icon" href="/favicon.png" >
<link rel="manifest" href="/manifest.json">
<link rel="canonical" href="http://localhost:1313/docs/study/system-design/doctolib-system-design/">
<link rel="stylesheet" href="/book.min.06d84d78247e572aefdb64432e406e1f78a9ead4ef25479efa82ff79bd6c0873.css" integrity="sha256-BthNeCR&#43;Vyrv22RDLkBuH3ip6tTvJUee&#43;oL/eb1sCHM=" crossorigin="anonymous">
  <script defer src="/fuse.min.js"></script>
  <script defer src="/zh.search.min.3ce0be7c81ef4776bfb2a552a4c5319a8bc833beeb59e10787e3f76f3a620ee3.js" integrity="sha256-POC&#43;fIHvR3a/sqVSpMUxmovIM77rWeEHh&#43;P3bzpiDuM=" crossorigin="anonymous"></script>

  <script defer src="/sw.min.6f6f90fcb8eb1c49ec389838e6b801d0de19430b8e516902f8d75c3c8bd98739.js" integrity="sha256-b2&#43;Q/LjrHEnsOJg45rgB0N4ZQwuOUWkC&#43;NdcPIvZhzk=" crossorigin="anonymous"></script>
<!--
Made with Book Theme
https://github.com/alex-shpak/hugo-book
-->
  
</head>
<body dir="ltr">
  <input type="checkbox" class="hidden toggle" id="menu-control" />
  <input type="checkbox" class="hidden toggle" id="toc-control" />
  <main class="container flex">
    <aside class="book-menu">
      <div class="book-menu-content">
        
  <nav>
<h2 class="book-brand">
  <a class="flex align-center" href="/"><span>君宝的笔记</span>
  </a>
</h2>


<div class="book-search hidden">
  <input type="text" id="book-search-input" placeholder="搜索" aria-label="搜索" maxlength="64" data-hotkeys="s/" />
  <div class="book-search-spinner hidden"></div>
  <ul id="book-search-results"></ul>
</div>
<script>document.querySelector(".book-search").classList.remove("hidden")</script>



  



  
    
  



<ul class="book-languages">
  <li>
    <input type="checkbox" id="languages" class="toggle" />
    <label for="languages" class="flex justify-between">
      <a role="button" class="flex align-center">
        <img src="/svg/translate.svg" class="book-icon" alt="Languages" />
        简体中文
      </a>
    </label>

    <ul>
      
      <li>
        <a href="/en/">
          English
        </a>
      </li>
      
    </ul>
  </li>
</ul>














  
  <ul>
    
      
        <li class="book-section-flat" >
          
  
  

  
    <input type="checkbox" id="section-51faac69e5e901597a0480b538fe5e9e" class="toggle" checked />
    <label for="section-51faac69e5e901597a0480b538fe5e9e" class="flex justify-between">
      <a role="button" class="">学习资料</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-f24aaea3accf88abc877401f4ea14426" class="toggle"  />
    <label for="section-f24aaea3accf88abc877401f4ea14426" class="flex justify-between">
      <a role="button" class="">Python</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/docs/study/python/base/" class="">Python 基础</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-582da456f48414d663a4153b7d734ed6" class="toggle"  />
    <label for="section-582da456f48414d663a4153b7d734ed6" class="flex justify-between">
      <a role="button" class="">安全</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/docs/study/security/replay-attack/" class="">重放攻击</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-407d2f8dd9410e8eef358914dd8c0dc2" class="toggle"  />
    <label for="section-407d2f8dd9410e8eef358914dd8c0dc2" class="flex justify-between">
      <a role="button" class="">缓存</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/docs/study/cache/solution/" class="">方案</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-e8dd3e3cc6bf1cd4a7414fff39582ee8" class="toggle"  />
    <label for="section-e8dd3e3cc6bf1cd4a7414fff39582ee8" class="flex justify-between">
      <a role="button" class="">基础</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/docs/study/base/saga-best-practices/" class="">Saga 模式最佳实践</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/study/base/license-comparison/" class="">主流许可证对比</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-57eec37e4d3dd0c268dbeb31bc61d4b1" class="toggle"  />
    <label for="section-57eec37e4d3dd0c268dbeb31bc61d4b1" class="flex justify-between">
      <a role="button" class="">前端</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/docs/study/frontend/react-knowledge/" class="">React 知识</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-70d792a755054f6bbbb3adad5db99041" class="toggle"  />
    <label for="section-70d792a755054f6bbbb3adad5db99041" class="flex justify-between">
      <a role="button" class="">数据库</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/docs/study/database/postgresql-mysql/" class="">PostgreSQL vs MySQL (InnoDB) 选型</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-3ba9e8b376ea48d5beb815b520fdce5d" class="toggle"  />
    <label for="section-3ba9e8b376ea48d5beb815b520fdce5d" class="flex justify-between">
      <a role="button" class="">网络</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/docs/study/network/http-comparison/" class="">HTTP 协议各版本比较</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/study/network/rtt/" class="">往返时间（Round Trip Time）</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-a1d7a3583cdff606ffe4820acf270df1" class="toggle" checked />
    <label for="section-a1d7a3583cdff606ffe4820acf270df1" class="flex justify-between">
      <a role="button" class="">系统设计</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/docs/study/system-design/system-design/" class="">系统设计</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/study/system-design/doctolib-tips/" class="">Doctolib 大纲</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/study/system-design/doctolib-system-design/" class="active">Doctolib 系统设计</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/study/system-design/rpc/" class="">RPC 框架</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/study/system-design/high-availability/" class="">高可用性</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/study/system-design/cache-consistency/" class="">缓存一致性</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-92f7d13098d747ba4906005529a0358a" class="toggle"  />
    <label for="section-92f7d13098d747ba4906005529a0358a" class="flex justify-between">
      <a role="button" class="">中间件</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <span>Kafka</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/docs/study/middleware/kafka/exactly-once/" class="">Kafka Exactly-Once</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/study/middleware/kafka/microservices-comm/" class="">微服务通信</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/study/middleware/netty/" class="">Netty 详解</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <span>OAuth2</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/docs/study/middleware/oauth2/auth-code/" class="">授权码模式</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li class="book-section-flat" >
          
  
  

  
    <input type="checkbox" id="section-6711a471a1458349986928f5c4b580ef" class="toggle"  />
    <label for="section-6711a471a1458349986928f5c4b580ef" class="flex justify-between">
      <a role="button" class="">自省</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/docs/introspection/juc/" class="">Java.util.concurrent 包</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li class="book-section-flat" >
          
  
  

  
    <input type="checkbox" id="section-06148cf0da5a87ffda4f34920eae5a83" class="toggle"  />
    <label for="section-06148cf0da5a87ffda4f34920eae5a83" class="flex justify-between">
      <a href="/docs/example/" class="">Example Site</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/docs/example/table-of-contents/" class="">Table of Contents</a>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/docs/example/table-of-contents/with-toc/" class="">With ToC</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/example/table-of-contents/without-toc/" class="">Without ToC</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-dcab297e11de79eb42396c59d3314623" class="toggle"  />
    <label for="section-dcab297e11de79eb42396c59d3314623" class="flex justify-between">
      <a role="button" class="">Collapsed</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/docs/example/collapsed/3rd-level/" class="">3rd Level</a>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/docs/example/collapsed/3rd-level/4th-level/" class="">4th Level</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/example/introduction/" class="">介绍</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li class="book-section-flat" >
          
  
  

  
    <input type="checkbox" id="section-25b4439e87cf8c09de5a8727ce755d08" class="toggle"  />
    <label for="section-25b4439e87cf8c09de5a8727ce755d08" class="flex justify-between">
      <a role="button" class="">Shortcodes</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/docs/shortcodes/buttons/" class="">Buttons</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/shortcodes/columns/" class="">Columns</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/shortcodes/details/" class="">Details</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/shortcodes/hints/" class="">Hints</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/shortcodes/mermaid/" class="">Mermaid</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/shortcodes/tabs/" class="">Tabs</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/shortcodes/katex/" class="">KaTeX</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
  </ul>










  
<ul>
  
  <li>
    <a href="https://github.com/jduan1993"  target="_blank" rel="noopener">
        Github
      </a>
  </li>
  
</ul>






</nav>




  <script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script>


 
      </div>
    </aside>

    <div class="book-page">
      <header class="book-header">
        
  <div class="flex align-center justify-between">
  <label for="menu-control">
    <img src="/svg/menu.svg" class="book-icon" alt="Menu" />
  </label>

  <h3>Doctolib 系统设计</h3>

  <label for="toc-control">
    
    <img src="/svg/toc.svg" class="book-icon" alt="Table of Contents" />
    
  </label>
</div>

<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
  <meta name="referrer" content="no-referrer-when-downgrade">

  
  <aside class="hidden clearfix">
    
  
<style>
    .no-marker::marker {
        content: none;
    }
</style>
<li class="no-marker"><a href="#Doctolib%20%e7%b3%bb%e7%bb%9f%e8%ae%be%e8%ae%a1">Doctolib 系统设计</a></li>
<nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#1-非功能需求与业务规模">1. 非功能需求与业务规模</a></li>
        <li><a href="#2-总体架构概览">2. 总体架构概览</a></li>
        <li><a href="#3-api-gateway-与服务通信">3. API Gateway 与服务通信</a></li>
        <li><a href="#4-身份认证与授权">4. 身份认证与授权</a></li>
        <li><a href="#5-数据存储方案">5. 数据存储方案</a>
          <ul>
            <li><a href="#51-关系型数据库主数据与事务">5.1 关系型数据库（主数据与事务）</a></li>
            <li><a href="#52-搜索索引全文与属性检索">5.2 搜索索引（全文与属性检索）</a></li>
            <li><a href="#53-缓存层">5.3 缓存层</a></li>
            <li><a href="#54-消息与事件总线">5.4 消息与事件总线</a></li>
          </ul>
        </li>
        <li><a href="#6-搜索流程设计">6. 搜索流程设计</a></li>
        <li><a href="#7-可用时段availability设计">7. 可用时段（Availability）设计</a>
          <ul>
            <li><a href="#71-概念模型">7.1 概念模型</a></li>
            <li><a href="#72-存储与计算">7.2 存储与计算</a></li>
          </ul>
        </li>
        <li><a href="#8-预约booking设计">8. 预约（Booking）设计</a>
          <ul>
            <li><a href="#81-业务流程">8.1 业务流程</a></li>
            <li><a href="#82-并发与一致性">8.2 并发与一致性</a></li>
          </ul>
        </li>
        <li><a href="#9-异步任务与事件驱动">9. 异步任务与事件驱动</a></li>
        <li><a href="#10-缓存与限流">10. 缓存与限流</a></li>
        <li><a href="#11-多区域与国际化">11. 多区域与国际化</a></li>
        <li><a href="#12-安全与合规">12. 安全与合规</a></li>
        <li><a href="#13-监控与可观察性">13. 监控与可观察性</a></li>
        <li><a href="#14-cicd-与自动化">14. CI/CD 与自动化</a></li>
        <li><a href="#15-测试策略">15. 测试策略</a></li>
        <li><a href="#16-技术选型小结与理由">16. 技术选型小结与理由</a></li>
        <li><a href="#17-多国家上线流程示例">17. 多国家上线流程示例</a></li>
        <li><a href="#18-容错与降级设计">18. 容错与降级设计</a></li>
        <li><a href="#19-监控扩容规划">19. 监控扩容规划</a></li>
        <li><a href="#20-业务监测与优化">20. 业务监测与优化</a></li>
        <li><a href="#21-总结">21. 总结</a></li>
      </ul>
    </li>
  </ul>
</nav>



  </aside>
  
 
      </header>

      
      
<article class="markdown book-post">
  <h1 id="Doctolib 系统设计">
    Doctolib 系统设计
    <a class="anchor" href="#Doctolib%20%e7%b3%bb%e7%bb%9f%e8%ae%be%e8%ae%a1">#</a>
  </h1>
  
  <div><a class="flex align-center" href="https://github.com/jduan1993/jduan1993.github.io/commit/c29164a052168171a61a7da777fc7a2880e57b3b" title='最后修改者 jduan1993 | 六月 24, 2025' target="_blank" rel="noopener">
    <img src="/svg/calendar.svg" class="book-icon" alt="" />
    <span>六月 24, 2025</span>
    </a>
  </div>
  
  


  

  


  <div class="book-post-content"><p>以下给出一个面向生产环境、可扩展且高可用的微服务架构设计方案，重点关注“患者搜索与预约”这一日历（Calendar）功能的重构。方案会针对各子系统划分、技术选型、可扩展性、容错、数据一致性、多区域部署等方面进行说明，并针对每个组件选用的语言或技术做出理由说明。</p>
<hr>
<h2 id="1-非功能需求与业务规模">
  1. 非功能需求与业务规模
  <a class="anchor" href="#1-%e9%9d%9e%e5%8a%9f%e8%83%bd%e9%9c%80%e6%b1%82%e4%b8%8e%e4%b8%9a%e5%8a%a1%e8%a7%84%e6%a8%a1">#</a>
</h2>
<ul>
<li>
<p><strong>规模要求</strong></p>
<ul>
<li>患者数量：50M</li>
<li>从业者数量：500K</li>
<li>并发搜索：700 次/秒</li>
<li>并发预约（booking）：90 次/秒</li>
</ul>
</li>
<li>
<p><strong>可扩展性</strong></p>
<ul>
<li>支持快速上线新国家/地区</li>
<li>支持水平扩展（水平扩容实例）</li>
</ul>
</li>
<li>
<p><strong>高可用、容错、降级</strong></p>
<ul>
<li>单点故障需避免</li>
<li>任一组件出故障时，应保证核心功能（如查询缓存、只读搜索）尽可能可用，写操作可做限流或降级提示</li>
</ul>
</li>
<li>
<p><strong>数据一致性</strong></p>
<ul>
<li>预约（Booking）流程需强一致或可接受的约束下的弱一致（依实践设计），但冲突需被正确检测并妥善处理。</li>
<li>搜索结果可采用近实时（Eventual Consistency）方式更新。</li>
</ul>
</li>
<li>
<p><strong>响应时延</strong></p>
<ul>
<li>搜索响应：百毫秒级</li>
<li>预约确认：次秒级体验</li>
</ul>
</li>
<li>
<p><strong>安全与合规</strong></p>
<ul>
<li>涉及医疗数据或个人信息，需符合相关法规（如 GDPR、HIPAA 等，视具体国家要求）</li>
<li>传输加密（TLS），存储加密，细粒度权限控制</li>
</ul>
</li>
<li>
<p><strong>可观察性</strong></p>
<ul>
<li>全链路追踪、日志、指标监控、告警</li>
</ul>
</li>
<li>
<p><strong>自动化运维 / CI/CD</strong></p>
<ul>
<li>基于容器化与基础设施即代码（IaC），实现流水线自动化部署、滚动升级、灰度发布</li>
</ul>
</li>
</ul>
<hr>
<h2 id="2-总体架构概览">
  2. 总体架构概览
  <a class="anchor" href="#2-%e6%80%bb%e4%bd%93%e6%9e%b6%e6%9e%84%e6%a6%82%e8%a7%88">#</a>
</h2>
<p>采用微服务架构 + API Gateway + 服务网格（可选） + 多区域部署 + 弹性伸缩。核心组件：</p>
<ol>
<li><strong>API Gateway</strong>：统一入口，做认证鉴权、限流、路由。</li>
<li><strong>Auth 服务</strong>：处理登录、认证、授权（OAuth2 / JWT）。</li>
<li><strong>User 服务</strong>：管理患者与从业者的 Profile 信息。</li>
<li><strong>Search 服务</strong>：负责处理按位置、专科、可用时段等条件的搜索请求；依赖搜索索引（Elasticsearch）。</li>
<li><strong>Availability 服务</strong>：维护和计算从业者可预约时段（working hours + 例外情况 + 节假日 + 已有预约冲突）。</li>
<li><strong>Booking 服务</strong>：处理预约创建、修改、取消事务，确保并发安全与一致性。</li>
<li><strong>Notification 服务</strong>：异步发送邮件/SMS/Push 推送（预约确认、提醒、变更通知）。</li>
<li><strong>Analytics / Monitoring 服务</strong>（或外部）：收集日志、指标，用于监控与数据分析。</li>
<li><strong>Payment / Billing 服务</strong>（如需付费预约，可选）。</li>
<li><strong>配置与管理服务</strong>：管理多国家/地区配置（时区、节假日规则、语言、合规设置等）。</li>
<li><strong>异步消息平台</strong>（如 Kafka）：用于事件流（Event Bus），实现微服务间的解耦异步通信，如预约事件、索引更新、通知触发等。</li>
<li><strong>缓存层</strong>：Redis，用于热点数据、短期缓存、分布式锁等。</li>
<li><strong>数据库</strong>：关系型数据库（PostgreSQL/CockroachDB/Vitess+MySQL/Aurora 等）；可根据跨区域需求选择分布式SQL（如 CockroachDB）或各区域独立数据库并做异步复制。</li>
<li><strong>搜索引擎</strong>：Elasticsearch 或 OpenSearch，用于地理位置与属性过滤、可用性初筛索引等。</li>
<li><strong>基础设施与部署</strong>：容器化（Docker）、Kubernetes（EKS/GKE/AKS 或自托管 K8s）、Terraform/CloudFormation 管理资源，多区域集群部署。</li>
</ol>
<p>下面分模块详细阐述，并说明选型理由。</p>
<hr>
<h2 id="3-api-gateway-与服务通信">
  3. API Gateway 与服务通信
  <a class="anchor" href="#3-api-gateway-%e4%b8%8e%e6%9c%8d%e5%8a%a1%e9%80%9a%e4%bf%a1">#</a>
</h2>
<ul>
<li>
<p><strong>API Gateway</strong>：推荐使用 Kong、Envoy+Istio、AWS API Gateway 等。</p>
<ul>
<li>
<p><strong>职责</strong>：统一入口，做认证鉴权（和 Auth 服务配合）、流量限流、灰度发布路由、TLS 终端、接口版本管理、监控指标采集。</p>
</li>
<li>
<p><strong>技术选型</strong>：</p>
<ul>
<li>Kong / Envoy：成熟、社区活跃、易与服务网格集成；</li>
<li>通过 Envoy 配合 Istio 等服务网格，可实现更细粒度的流量管理、熔断限流、链路追踪注入。</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>通信协议</strong>：</p>
<ul>
<li>微服务间内部通信可优先用 gRPC（性能、IDL、强类型契约），也可选 REST/JSON（兼容性好）；若已有生态偏好 Java/Kotlin Spring Boot，可用 gRPC + Protobuf，或 REST+OpenAPI。</li>
<li>外部客户端与 Gateway，一般用 HTTPS/JSON+REST 或 GraphQL（若业务需要聚合多个服务数据）。本场景搜索与预约流程较简单，用 REST 即可。</li>
</ul>
</li>
</ul>
<hr>
<h2 id="4-身份认证与授权">
  4. 身份认证与授权
  <a class="anchor" href="#4-%e8%ba%ab%e4%bb%bd%e8%ae%a4%e8%af%81%e4%b8%8e%e6%8e%88%e6%9d%83">#</a>
</h2>
<ul>
<li>
<p><strong>Auth 服务</strong>：</p>
<ul>
<li><strong>协议</strong>：OAuth2 / OpenID Connect + JWT。</li>
<li><strong>存储</strong>：用户凭证信息（如果用用户名密码）、第三方登录（如 SSO）凭证等。</li>
<li><strong>选型理由</strong>：业界标准，JWT 可在微服务间传递用户信息（Claims），便于鉴权；若对安全要求高，可采用刷新 token 机制或短期 token 并使用 Refresh Token。</li>
</ul>
</li>
<li>
<p><strong>权限控制</strong>：RBAC/ACL 机制。预约系统中，大多数操作由患者或从业者自行发起，仅需保证患者只可访问自己预约记录；管理员可访问更多。</p>
</li>
<li>
<p><strong>语言/框架</strong>：</p>
<ul>
<li>Java/Kotlin Spring Security、Go+Oauth2库，或 Node.js+Passport，根据团队熟悉选择。</li>
<li>推荐 Golang：二进制轻量、性能高、并发处理优秀；或 Kotlin(Spring Boot)：生态成熟、开发效率高。</li>
</ul>
</li>
</ul>
<hr>
<h2 id="5-数据存储方案">
  5. 数据存储方案
  <a class="anchor" href="#5-%e6%95%b0%e6%8d%ae%e5%ad%98%e5%82%a8%e6%96%b9%e6%a1%88">#</a>
</h2>
<h3 id="51-关系型数据库主数据与事务">
  5.1 关系型数据库（主数据与事务）
  <a class="anchor" href="#51-%e5%85%b3%e7%b3%bb%e5%9e%8b%e6%95%b0%e6%8d%ae%e5%ba%93%e4%b8%bb%e6%95%b0%e6%8d%ae%e4%b8%8e%e4%ba%8b%e5%8a%a1">#</a>
</h3>
<ul>
<li>
<p><strong>主要用途</strong>：存储患者、从业者、预约记录、可用时段模板、地点/诊所信息、专科分类、审计日志等。</p>
</li>
<li>
<p><strong>选型</strong>：</p>
<ul>
<li><strong>PostgreSQL</strong>：强一致、复杂查询能力好、支持地理扩展 PostGIS，可处理位置数据。</li>
<li><strong>CockroachDB</strong> 或 <strong>Google Spanner</strong>（若云上需求）：提供分布式 SQL，本身支持跨多区域部署和强一致事务，便于全球部署，但成本较高；</li>
<li><strong>Vitess+MySQL / Amazon Aurora MySQL/PostgreSQL</strong>：可水平分片；适合已有 MySQL 生态的团队。</li>
</ul>
</li>
<li>
<p><strong>分区/分片策略</strong>：</p>
<ul>
<li>可按国家/地区分库：每个国家单独数据库实例/集群，避免跨区域写延迟，同时便于合规隔离（例如 GDPR 区域）。</li>
<li>同一国家内部可对患者或从业者做分表（sharding），如按用户ID hash。</li>
<li>CockroachDB 场景下可利用其多区域分布能力，无需复杂分片逻辑；但需评估延迟与成本。</li>
</ul>
</li>
<li>
<p><strong>事务处理</strong>：</p>
<ul>
<li>预约创建/取消需强一致：在单库或同分区中用数据库事务（SELECT FOR UPDATE、乐观锁或悲观锁）确保并发安全；避免跨分区事务。</li>
<li>若某些操作需跨库（如 Billing 在不同服务库），可采用 Saga 模式：分布式事务编排，补偿流程确保最终一致。</li>
</ul>
</li>
</ul>
<h3 id="52-搜索索引全文与属性检索">
  5.2 搜索索引（全文与属性检索）
  <a class="anchor" href="#52-%e6%90%9c%e7%b4%a2%e7%b4%a2%e5%bc%95%e5%85%a8%e6%96%87%e4%b8%8e%e5%b1%9e%e6%80%a7%e6%a3%80%e7%b4%a2">#</a>
</h3>
<ul>
<li>
<p><strong>Elasticsearch / OpenSearch</strong>：</p>
<ul>
<li><strong>用途</strong>：地理位置搜索（Geo distance queries）、按专科标签过滤、可用性初步筛选（如下一可用日期/时间区间标记）、全文搜索（诊所描述、评论）。</li>
<li><strong>部署</strong>：多节点集群，按国家/区域分集群或索引分片；考虑跨区域读副本以降低延迟。</li>
<li><strong>更新方式</strong>：异步事件驱动更新：Booking 服务或 Availability 服务在预约创建/取消后发事件，经消息队列 Worker 更新索引（近实时）。需注意“搜索结果可能有短暂延迟”；对此在 UX 上可提示“可用性可能实时性略有延迟，请实时尝试预约”。</li>
<li><strong>选型理由</strong>：支持丰富查询、横向扩展成熟、支持地理距离计算和复杂过滤。</li>
</ul>
</li>
</ul>
<h3 id="53-缓存层">
  5.3 缓存层
  <a class="anchor" href="#53-%e7%bc%93%e5%ad%98%e5%b1%82">#</a>
</h3>
<ul>
<li>
<p><strong>Redis / Memcached</strong>：</p>
<ul>
<li><strong>用途</strong>：热点搜索结果缓存（如常见城市+专科检索）、会话信息、配额限流计数、分布式锁。</li>
<li><strong>选型</strong>：Redis 更灵活，支持数据结构和分布式锁（Redlock），建议选 Redis Cluster 部署。</li>
<li><strong>注意</strong>：缓存失效策略要设计合理；对搜索缓存可用 TTL 结合缓存击穿预防（如使用热点预热或互斥锁）。</li>
</ul>
</li>
</ul>
<h3 id="54-消息与事件总线">
  5.4 消息与事件总线
  <a class="anchor" href="#54-%e6%b6%88%e6%81%af%e4%b8%8e%e4%ba%8b%e4%bb%b6%e6%80%bb%e7%ba%bf">#</a>
</h3>
<ul>
<li>
<p><strong>Kafka / Pulsar / RabbitMQ</strong>：</p>
<ul>
<li>
<p><strong>用途</strong>：实现异步、解耦：</p>
<ul>
<li>预约创建/取消事件发出后，异步触发索引更新、通知发送、统计更新等；</li>
<li>日志、指标事件汇聚。</li>
</ul>
</li>
<li>
<p><strong>选型理由</strong>：Kafka 在高吞吐、分区扩展、消息持久化方面成熟；Pulsar 也可；RabbitMQ 适合较少消息量或简单场景。此处高并发场景应选 Kafka。</p>
</li>
<li>
<p><strong>部署</strong>：Kafka 集群，多分区分区键可按国家或服务类型区分，便于消费侧并行消费。</p>
</li>
</ul>
</li>
</ul>
<hr>
<h2 id="6-搜索流程设计">
  6. 搜索流程设计
  <a class="anchor" href="#6-%e6%90%9c%e7%b4%a2%e6%b5%81%e7%a8%8b%e8%ae%be%e8%ae%a1">#</a>
</h2>
<ol>
<li>
<p><strong>用户请求</strong>：前端通过 API Gateway 发搜索请求，带入位置（经纬度或城市ID）、专科（标签）、可用日期范围（如“本周有空”）、其他过滤（语言、性别偏好等）。</p>
</li>
<li>
<p><strong>Search 服务</strong></p>
<ul>
<li>
<p><strong>逻辑</strong>：先校验请求参数；构造 Elasticsearch 查询：</p>
<ul>
<li>
<p>Geo Distance filter：基于用户位置和诊所/从业者所在诊所位置计算距离并排序（可分页）。</p>
</li>
<li>
<p>专科 filter：term filter on specialty field。</p>
</li>
<li>
<p>可用性 filter：如果索引中提前标注了“下一可用日期”字段，可做范围过滤（例如 next_available_date &lt;= 本周末）；若需要更实时的可用时段判断，可：</p>
<ul>
<li>在搜索阶段只做粗筛（例如只筛选标记有空闲的从业者或诊所），真正的可用时段详情由前端在候选列表中点击后，再调用 Availability 服务实时获取具体可用时段。</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>缓存</strong>：对高频查询（如大城市常用专科）可在 Redis 缓存搜索结果列表ID和简单摘要，TTL 10-30s，减轻 ES 压力。</p>
</li>
<li>
<p><strong>分页与排序</strong>：支持分页（深分页需谨慎，可用 search_after 或基于游标分页），排序可按距离、评分或综合得分。</p>
</li>
<li>
<p><strong>响应</strong>：返回候选列表（带从业者ID、诊所信息基础、评分、下一可用日期等），由前端展示；若用户进一步要求“查看具体可用时段”，再调用 Availability 服务。</p>
</li>
</ul>
</li>
<li>
<p><strong>技术语言</strong>：</p>
<ul>
<li>
<p>Search 服务推荐使用 <strong>Go</strong> 或 <strong>Kotlin/Java</strong>：</p>
<ul>
<li>Go：高并发、轻量二进制、启动快、易部署；Elasticsearch 客户端成熟，适合高 QPS。</li>
<li>Java/Kotlin：生态成熟，原生 ES 客户端支持好；若团队已有 Spring Boot 经验，可快速集成监控、配置中心等。</li>
</ul>
</li>
<li>
<p>Node.js 也可，但在高并发网络 IO 场景下 Go 性能更优且资源占用更低。</p>
</li>
</ul>
</li>
</ol>
<hr>
<h2 id="7-可用时段availability设计">
  7. 可用时段（Availability）设计
  <a class="anchor" href="#7-%e5%8f%af%e7%94%a8%e6%97%b6%e6%ae%b5availability%e8%ae%be%e8%ae%a1">#</a>
</h2>
<h3 id="71-概念模型">
  7.1 概念模型
  <a class="anchor" href="#71-%e6%a6%82%e5%bf%b5%e6%a8%a1%e5%9e%8b">#</a>
</h3>
<ul>
<li><strong>Working Hours Template</strong>：从业者在各诊所或远程的常规可用时间段（例如周一9:00-12:00，14:00-18:00）。</li>
<li><strong>例外情况（Exceptions）</strong>：请假、临时关闭、假期、临时加班、手动阻塞时间段等。</li>
<li><strong>已预约时段（Existing Bookings）</strong>：已被其他患者预订的时段。</li>
<li><strong>缓冲/准备时间</strong>：某些服务需要在预约前后留出准备或清洁时间。</li>
<li><strong>时区</strong>：从业者与患者可能跨时区，对本地时间转换需谨慎，统一以 UTC 存储。</li>
</ul>
<h3 id="72-存储与计算">
  7.2 存储与计算
  <a class="anchor" href="#72-%e5%ad%98%e5%82%a8%e4%b8%8e%e8%ae%a1%e7%ae%97">#</a>
</h3>
<ul>
<li>
<p><strong>存储方案</strong>：</p>
<ul>
<li>
<p>Working Hours Template &amp; Exceptions 存在关系型数据库表：</p>
<ul>
<li><code>practitioner_availability_template(practitioner_id, weekday, start_time, end_time, duration_slot, buffer_before, buffer_after)</code></li>
<li><code>availability_exceptions(practitioner_id, date, start_time, end_time, type)</code></li>
</ul>
</li>
<li>
<p>已预约记录存在 <code>appointments</code> 表，并在 Booking 时写入。</p>
</li>
</ul>
</li>
<li>
<p><strong>计算实时可用时段</strong>：</p>
<ul>
<li>
<p><strong>方法 1：实时计算</strong></p>
<ul>
<li>API 调用 Availability 服务时，根据 template + exceptions + existing bookings，从目标日期范围内生成所有候选时隙，并排除冲突与缓冲区，返回可选时段列表。适合针对单个从业者或少量并发请求。</li>
<li>优点：实时准确，无需预存；缺点：若请求量大或查询范围大（比如批量查询多位从业者多个时间范围），计算开销可能高，需做好并发优化。</li>
</ul>
</li>
<li>
<p><strong>方法 2：预计算 / 缓存</strong></p>
<ul>
<li>系统定期（如每天凌晨或增量事件驱动）为每个从业者生成未来N天（如7天或14天）的可用时段列表，存于一个快速查询的存储（如 Redis 或专门的 NoSQL 表）。Booking 或 Search 阶段可直接查询缓存数据。</li>
<li>增量更新：当有预约创建/取消或 Exceptions 变更时，通过事件流触发更新对应从业者在缓存中的可用时段。</li>
<li>优点：查询快速，适合搜索大批从业者时初筛；缺点：需要设计更新机制，保证近实时。</li>
</ul>
</li>
<li>
<p><strong>推荐</strong>：结合两者：对于 Search 阶段，仅需知道“是否有可用”，可在预计算索引（例如 Elastic 索引中的 next_available_date 字段、或 Redis 中小体量标记）中标注；若用户选定某位从业者/诊所并选日期，则再调用实时计算以获取具体时隙，或从预计算缓存读取（若足够实时）。</p>
</li>
</ul>
</li>
<li>
<p><strong>语言/框架</strong>：</p>
<ul>
<li>Availability 服务可用 <strong>Go</strong> 实现，具备高并发处理能力；也可用 <strong>Kotlin/Java</strong>，若与业务团队偏好一致。核心计算逻辑需高效实现（如时间区间运算、冲突检测），可复用已有库或自行实现。</li>
</ul>
</li>
<li>
<p><strong>并发处理</strong>：</p>
<ul>
<li>
<p>对单个从业者的 Availability 计算请求，相对独立；可水平扩展 Availability 服务实例。</p>
</li>
<li>
<p>预计算任务可由专门 Worker 集群（Kafka Consumer）处理，语言可选 Python 或 Go：</p>
<ul>
<li>Python：开发效率高，可用 Pandas 等库做批量计算；但需注意性能和并发；</li>
<li>Go：若要求高并发、低延迟，也可用 Go Worker。</li>
</ul>
</li>
<li>
<p>建议实时在线计算由 Go 服务完成；批量预计算 Worker 可根据团队技术栈在 Python/Go 之间选择。</p>
</li>
</ul>
</li>
</ul>
<hr>
<h2 id="8-预约booking设计">
  8. 预约（Booking）设计
  <a class="anchor" href="#8-%e9%a2%84%e7%ba%a6booking%e8%ae%be%e8%ae%a1">#</a>
</h2>
<h3 id="81-业务流程">
  8.1 业务流程
  <a class="anchor" href="#81-%e4%b8%9a%e5%8a%a1%e6%b5%81%e7%a8%8b">#</a>
</h3>
<ol>
<li>
<p>患者在某时段点击“预约”</p>
</li>
<li>
<p>Booking 服务校验请求：</p>
<ul>
<li>患者身份有效</li>
<li>预约时段在可用范围内（再次检查，防止脏读缓存导致冲突）</li>
<li>若需要付费，触发 Payment 服务（可异步或同步，视业务）。</li>
</ul>
</li>
<li>
<p>创建预约记录：写入关系型数据库；同时可能要更新缓存的可用时段、通知事件、索引更新。</p>
</li>
<li>
<p>发送确认给患者与从业者（同步等待或异步后续）。</p>
</li>
<li>
<p>支持后续修改/取消：需再次做冲突检查与数据库更新，并触发更新事件。</p>
</li>
</ol>
<h3 id="82-并发与一致性">
  8.2 并发与一致性
  <a class="anchor" href="#82-%e5%b9%b6%e5%8f%91%e4%b8%8e%e4%b8%80%e8%87%b4%e6%80%a7">#</a>
</h3>
<ul>
<li>
<p><strong>并发冲突场景</strong>：多个患者同时请求同一从业者同一时段。</p>
</li>
<li>
<p><strong>处理策略</strong>：</p>
<ul>
<li><strong>悲观锁</strong>：在数据库层对该从业者对应的当天时段加锁（如 SELECT &hellip; FOR UPDATE on availability-related row）；缺点是在高并发下热点锁竞争严重；</li>
<li><strong>乐观锁 / CAS</strong>：在预约表或 availability cache 中用版本号或标志位做乐观并发控制；可能需要重试逻辑；</li>
<li><strong>分布式锁</strong>：利用 Redis Redlock 或 Zookeeper 针对单个从业者进行锁，控制同一时段只有一个请求落地；需注意锁超时与可靠性；</li>
<li><strong>分区设计</strong>：将同一从业者或诊所的预约请求都路由到同一数据库分区或实例，避免跨分区事务；结合一致性哈希或路由规则。</li>
</ul>
</li>
<li>
<p><strong>推荐做法</strong>：</p>
<ul>
<li>将预约数据按从业者维度分区（同一从业者的预约写入同一分区/库），在该分区内用数据库事务（SELECT FOR UPDATE）或乐观锁确保同一时段只会被一个写成功。对于高并发热门医生，可预估并做限流。</li>
<li>Redis 分布式锁配合数据库事务：先在 Redis 上对 key = practitioner_id:date:timeslot 加锁，若获得锁则进入数据库事务检查并写入；写完后释放锁。超时控制要比数据库事务超时更长，避免死锁或提前释放。</li>
<li><strong>幂等性</strong>：前端在请求头带幂等ID，防止重复提交。</li>
</ul>
</li>
<li>
<p><strong>Saga 模式</strong>：若有跨服务依赖（如创建预约后需调用 Billing、Notification、Analytics），在主事务提交后发布“预约已创建”事件；各消费者按需处理（如扣款、发送邮件）。若 Billing 失败，可通过补偿事务或人工干预处理。</p>
</li>
<li>
<p><strong>技术语言</strong>：Booking 服务推荐使用 <strong>Go</strong> 或 <strong>Kotlin/Java</strong>。</p>
<ul>
<li>Go：轻量高并发，易部署；</li>
<li>Kotlin/Java：事务管理与生态成熟；Spring Transaction 支持多种数据库。</li>
</ul>
</li>
</ul>
<hr>
<h2 id="9-异步任务与事件驱动">
  9. 异步任务与事件驱动
  <a class="anchor" href="#9-%e5%bc%82%e6%ad%a5%e4%bb%bb%e5%8a%a1%e4%b8%8e%e4%ba%8b%e4%bb%b6%e9%a9%b1%e5%8a%a8">#</a>
</h2>
<ul>
<li>
<p><strong>消息总线</strong>：Kafka</p>
</li>
<li>
<p><strong>事件类型</strong>：</p>
<ul>
<li><code>AppointmentCreated</code>、<code>AppointmentCanceled</code>、<code>AppointmentRescheduled</code></li>
<li><code>AvailabilityChanged</code>（从业者修改模板或例外）</li>
<li><code>UserUpdated</code>、<code>PractitionerUpdated</code>（触发索引更新）</li>
<li><code>NotificationEvent</code>（由 Booking 或其他服务生产，再由 Notification 服务消费）</li>
<li><code>AnalyticsEvent</code>（如搜索行为、预约完成、取消率等）</li>
</ul>
</li>
<li>
<p><strong>消费者 Worker</strong>：</p>
<ul>
<li><strong>索引更新 Worker</strong>：消费事件后更新 Elasticsearch 索引（如更新 next_available_date、评分等），保持搜索结果近实时。</li>
<li><strong>Notification Worker</strong>：消费通知事件，通过邮件/SMS/Push 服务发送；可用 Node.js、Python 实现，方便集成第三方 SDK。</li>
<li><strong>Analytics Worker</strong>：消费行为事件，存入时序/分析系统（如 ClickHouse、BigQuery、InfluxDB 等），用于报表和机器学习。</li>
<li><strong>Cache 更新 Worker</strong>：当预约或可用性发生变更，更新 Redis 缓存中受影响的数据。</li>
</ul>
</li>
<li>
<p><strong>选型理由</strong>：Kafka 高吞吐、分区机制便于并行、多消费者组隔离。</p>
</li>
</ul>
<hr>
<h2 id="10-缓存与限流">
  10. 缓存与限流
  <a class="anchor" href="#10-%e7%bc%93%e5%ad%98%e4%b8%8e%e9%99%90%e6%b5%81">#</a>
</h2>
<ul>
<li>
<p><strong>热点缓存</strong>：Redis</p>
<ul>
<li>搜索缓存：基于查询参数 hash 做短期缓存；</li>
<li>可用性缓存：预计算后存储未来若干天的可用时段列表，Key = practitioner_id; TTL 或手动更新；</li>
<li>Session/Token 黑名单：若需要登出或撤销 token；</li>
</ul>
</li>
<li>
<p><strong>分布式锁</strong>：Redis Redlock，用于预约并发控制（如前述）。</p>
</li>
<li>
<p><strong>限流、熔断</strong>：</p>
<ul>
<li>在 API Gateway 层配置请求限流（防止洪水攻击或爬虫）；</li>
<li>服务内部可用令牌桶或漏桶算法做细粒度限流（例如对单个从业者的预约请求做速率限制）。</li>
</ul>
</li>
<li>
<p><strong>降级策略</strong>：</p>
<ul>
<li>当后端某服务故障时，对低优先级功能做降级（如搜索缓存返回旧结果，并在 UI 上提示“结果可能过时，请稍后重试”）。</li>
</ul>
</li>
</ul>
<hr>
<h2 id="11-多区域与国际化">
  11. 多区域与国际化
  <a class="anchor" href="#11-%e5%a4%9a%e5%8c%ba%e5%9f%9f%e4%b8%8e%e5%9b%bd%e9%99%85%e5%8c%96">#</a>
</h2>
<ul>
<li>
<p><strong>多国家/地区部署</strong>：</p>
<ul>
<li><strong>独立 Region 部署</strong>：针对不同国家/地区在对应区域（如 AWS 区域）部署独立集群，数据库本地化，减少跨洋延迟；合规隔离（数据驻留）。</li>
<li><strong>跨区域同步</strong>（可选）：若需要全球搜索（跨国搜索），需跨区域索引复制；或集中搜索集群，但会有延迟与合规风险，一般不推荐。推荐按国家隔离，未来如需全球入口可做独立服务聚合。</li>
<li><strong>配置中心</strong>：通过配置服务管理各国节假日规则、时区、语言文案、价格策略（若付费）、法规合规配置等；服务启动或运行时从配置中心获取对应国家配置。</li>
<li><strong>部署与 IaC</strong>：Terraform + Kubernetes + Helm Charts 实现可复制的集群模板，方便新国家快速上线；CI/CD 管道接入自动创建集群、部署服务。</li>
</ul>
</li>
<li>
<p><strong>时区处理</strong>：</p>
<ul>
<li>存储统一用 UTC，前端显示或用户输入时做时区转换；Availability 服务在计算时考虑从业者本地时区和患者本地时区。</li>
</ul>
</li>
<li>
<p><strong>多语言 / 文案</strong>：</p>
<ul>
<li>前端与后端支持国际化（i18n）；后端错误/消息 code 化，前端根据 locale 渲染文本。</li>
</ul>
</li>
<li>
<p><strong>货币与支付</strong>：若涉及付费预约，需支持各地货币、支付通道接入（Stripe、PayPal、本地支付网关），并做地域隔离。</p>
</li>
</ul>
<hr>
<h2 id="12-安全与合规">
  12. 安全与合规
  <a class="anchor" href="#12-%e5%ae%89%e5%85%a8%e4%b8%8e%e5%90%88%e8%a7%84">#</a>
</h2>
<ul>
<li><strong>传输加密</strong>：全链路 TLS。</li>
<li><strong>存储加密</strong>：数据库加密、S3 等存储加密。</li>
<li><strong>访问控制</strong>：最小权限原则，微服务间调用用 mTLS 或 JWT，严格控制 IAM 权限。</li>
<li><strong>敏感数据隔离</strong>：如医疗隐私、身份证号等，需做专门加密或token化存储，并限制访问日志记录级别。</li>
<li><strong>审计日志</strong>：记录关键操作（预约创建/取消/修改、权限变更等）到不可篡改存储，用于安全审计。</li>
<li><strong>DDoS 防护、WAF</strong>：在边缘层面或云服务商提供防护。</li>
<li><strong>合规</strong>：根据各国法规（GDPR、HIPAA 等），部署前做法律合规评估。</li>
</ul>
<hr>
<h2 id="13-监控与可观察性">
  13. 监控与可观察性
  <a class="anchor" href="#13-%e7%9b%91%e6%8e%a7%e4%b8%8e%e5%8f%af%e8%a7%82%e5%af%9f%e6%80%a7">#</a>
</h2>
<ul>
<li>
<p><strong>Metrics</strong>：Prometheus + Grafana。</p>
<ul>
<li>监控 API QPS、响应时延、错误率；各微服务资源（CPU/Mem/Disk）；Kafka 消费滞后；数据库连接池、锁等待、磁盘空间等。</li>
</ul>
</li>
<li>
<p><strong>日志</strong>：结构化日志（JSON），集中收集（ELK/EFK）。</p>
</li>
<li>
<p><strong>Tracing</strong>：OpenTelemetry + Jaeger/Zipkin，通过 API Gateway 注入 trace id，链路可视化，定位跨服务延迟。</p>
</li>
<li>
<p><strong>告警</strong>：设置阈值告警（例如搜索延迟超过某值、预约失败率异常上升、Kafka 滞后过高、数据库慢查询激增等），并集成 PagerDuty/Slack 等。</p>
</li>
<li>
<p><strong>健康检查</strong>：Kubernetes readiness/liveness probe；服务自带健康检查接口；自动重启故障实例。</p>
</li>
<li>
<p><strong>Chaos Testing</strong>：定期或在预生产环境做故障注入测试（断网、延迟、节点宕机），验证系统弹性和恢复能力。</p>
</li>
</ul>
<hr>
<h2 id="14-cicd-与自动化">
  14. CI/CD 与自动化
  <a class="anchor" href="#14-cicd-%e4%b8%8e%e8%87%aa%e5%8a%a8%e5%8c%96">#</a>
</h2>
<ul>
<li><strong>版本控制</strong>：Git + 分支策略（GitFlow/GitHub Flow）。</li>
<li><strong>容器化</strong>：Docker，镜像打包；多阶段构建以减小镜像体积。</li>
<li><strong>流水线</strong>：Jenkins/GitHub Actions/GitLab CI 等；包括代码检查、单元测试、集成测试、构建镜像、扫描安全漏洞、部署到测试环境、自动化测试（契约测试、端到端）、部署到生产。</li>
<li><strong>基础设施即代码</strong>：Terraform/CloudFormation 管理云资源；Helm Charts 或 Kustomize 管理 Kubernetes 部署清单；结合 ArgoCD/Flux 实现 GitOps。</li>
<li><strong>蓝绿部署 / 金丝雀发布</strong>：逐步流量切换，降低风险。</li>
<li><strong>回滚机制</strong>：自动化回滚脚本，若健康检查失败或监控告警，可快速回滚到稳定版本。</li>
</ul>
<hr>
<h2 id="15-测试策略">
  15. 测试策略
  <a class="anchor" href="#15-%e6%b5%8b%e8%af%95%e7%ad%96%e7%95%a5">#</a>
</h2>
<ul>
<li>
<p><strong>单元测试</strong>：各服务内核心逻辑（如 Availability 计算、Booking 并发冲突检测）。</p>
</li>
<li>
<p><strong>集成测试</strong>：模拟微服务间调用，可在测试环境中用 WireMock 或测试容器。</p>
</li>
<li>
<p><strong>契约测试</strong>：确保服务间 API 变更不会破坏消费者。</p>
</li>
<li>
<p><strong>性能测试</strong>：</p>
<ul>
<li><strong>Load Testing</strong>：用工具（Locust、JMeter）模拟 700 Search QPS、90 Booking QPS；监控各组件瓶颈并进行容量规划。</li>
<li><strong>压力测试</strong>：超高并发、故障场景；测试系统降级能力。</li>
</ul>
</li>
<li>
<p><strong>安全测试</strong>：扫描依赖漏洞（Snyk/OWASP）、渗透测试。</p>
</li>
<li>
<p><strong>可用性测试</strong>：Chaos Monkey 风格故障注入，验证自动恢复机制。</p>
</li>
</ul>
<hr>
<h2 id="16-技术选型小结与理由">
  16. 技术选型小结与理由
  <a class="anchor" href="#16-%e6%8a%80%e6%9c%af%e9%80%89%e5%9e%8b%e5%b0%8f%e7%bb%93%e4%b8%8e%e7%90%86%e7%94%b1">#</a>
</h2>
<ul>
<li>
<p><strong>微服务架构 + Kubernetes</strong>：避免单体，便于独立扩展、部署和团队并行开发；K8s 提供自愈、滚动升级、水平伸缩能力。</p>
</li>
<li>
<p><strong>语言</strong></p>
<ul>
<li><strong>Go</strong>：高并发、二进制部署简单、性能优越，适用于 Search、Availability、Booking 等核心高 QPS 服务。</li>
<li><strong>Kotlin/Java</strong>：若已有团队熟悉 Spring 生态，可快速开发，生态成熟；但相比 Go 启动更慢、资源消耗略高；适合需要复杂事务管理或已有大量 Java 库场景。</li>
<li><strong>Python/Node.js</strong>：用于异步 Worker（Notification、Analytics），因集成第三方 SDK、开发效率高；可根据性能需求在高吞吐场景下也可选 Go；</li>
</ul>
</li>
<li>
<p><strong>数据库</strong></p>
<ul>
<li><strong>PostgreSQL</strong>：成熟、稳定，支持复杂事务与地理位置扩展（PostGIS）；按国家分库部署。</li>
<li><strong>CockroachDB</strong>：若多区域一致性要求高、希望统一数据库层管理，可考虑，但需评估运维成本和延迟。</li>
</ul>
</li>
<li>
<p><strong>搜索</strong>：Elasticsearch/OpenSearch，用于地理过滤、属性过滤等。</p>
</li>
<li>
<p><strong>消息队列</strong>：Kafka，用于高吞吐异步事件。</p>
</li>
<li>
<p><strong>缓存/锁</strong>：Redis Cluster，用于热点缓存、分布式锁、限流。</p>
</li>
<li>
<p><strong>服务网格</strong>：Istio/Linkerd（可选），增强流量管理、TLS、观测。</p>
</li>
<li>
<p><strong>监控/日志/Tracing</strong>：Prometheus+Grafana、ELK/EFK、OpenTelemetry+Jaeger。</p>
</li>
<li>
<p><strong>CI/CD &amp; IaC</strong>：Terraform + Kubernetes + GitOps。</p>
</li>
<li>
<p><strong>容器运行环境</strong>：Docker + Kubernetes（云托管或自托管），结合自动扩缩容（HPA/VPA）。</p>
</li>
<li>
<p><strong>外部托管服务</strong>：邮件/SMS 推送用第三方服务（SendGrid/Twilio 等）；支付集成 Stripe/PayPal/本地支付；监控告警可集成 PagerDuty。</p>
</li>
</ul>
<hr>
<h2 id="17-多国家上线流程示例">
  17. 多国家上线流程示例
  <a class="anchor" href="#17-%e5%a4%9a%e5%9b%bd%e5%ae%b6%e4%b8%8a%e7%ba%bf%e6%b5%81%e7%a8%8b%e7%a4%ba%e4%be%8b">#</a>
</h2>
<ol>
<li>
<p><strong>准备阶段</strong></p>
<ul>
<li>在配置中心中添加新国家配置：时区、节假日规则、默认语言、合规要求、支付方式等。</li>
<li>Terraform 脚本：新增对应区域的 VPC、Kubernetes 集群节点组等资源定义。</li>
</ul>
</li>
<li>
<p><strong>部署基础设施</strong></p>
<ul>
<li>使用 Terraform 自动创建或扩容集群；</li>
<li>在 Kubernetes 中部署核心微服务（Deployment、StatefulSet、ConfigMap、Secret 等）。</li>
<li>初始化数据库：新国家数据库实例或分区。</li>
</ul>
</li>
<li>
<p><strong>同步数据与测试</strong></p>
<ul>
<li>根据需要同步基础字典数据（如专科类别、诊所注册表格字段等）；</li>
<li>在测试环境进行端到端测试；预热缓存；性能基准测试；</li>
<li>灰度发布：将少量流量导向新集群，观察监控指标。</li>
</ul>
</li>
<li>
<p><strong>正式上线</strong></p>
<ul>
<li>DNS / Gateway 配置：新国家域名或路径路由至对应集群；</li>
<li>开启监控告警；与当地支持团队、运维协作；</li>
<li>逐步扩大流量至全量；</li>
</ul>
</li>
<li>
<p><strong>迭代优化</strong></p>
<ul>
<li>根据使用情况优化资源配置；调整预计算窗口；增强缓存；</li>
<li>收集当地用户反馈，持续改进。</li>
</ul>
</li>
</ol>
<hr>
<h2 id="18-容错与降级设计">
  18. 容错与降级设计
  <a class="anchor" href="#18-%e5%ae%b9%e9%94%99%e4%b8%8e%e9%99%8d%e7%ba%a7%e8%ae%be%e8%ae%a1">#</a>
</h2>
<ul>
<li>
<p><strong>服务实例冗余</strong>：各微服务在多个节点多副本部署；K8s 自动重启。</p>
</li>
<li>
<p><strong>跨可用区部署</strong>：集群跨多个可用区，防止单 AZ 故障。</p>
</li>
<li>
<p><strong>Circuit Breaker / Retry</strong>：服务间调用出现故障时，快速失败并熔断，保护下游；重试机制带退避策略。</p>
</li>
<li>
<p><strong>降级方案</strong>：</p>
<ul>
<li>搜索服务失效时，可返回缓存结果或简化返回（如仅返回诊所列表、提示实时不可用）；</li>
<li>Availability 服务故障时，可显示近期缓存时段并提示“请刷新以获取实时可用”；</li>
<li>Booking 服务若短暂不可用，告知用户稍后重试或排队；可结合队列缓冲（但需谨慎，防止排队过久冲突）。</li>
</ul>
</li>
<li>
<p><strong>数据备份与恢复</strong>：</p>
<ul>
<li>定期备份数据库快照；Elasticsearch 快照；Kafka 数据保留；</li>
<li>制定灾难恢复（DR）预案，保证在区域故障时可快速恢复。</li>
</ul>
</li>
</ul>
<hr>
<h2 id="19-监控扩容规划">
  19. 监控扩容规划
  <a class="anchor" href="#19-%e7%9b%91%e6%8e%a7%e6%89%a9%e5%ae%b9%e8%a7%84%e5%88%92">#</a>
</h2>
<ul>
<li>
<p><strong>容量规划</strong>：</p>
<ul>
<li>根据 Load Testing 数据，预估搜索节点、ES 集群节点、数据库实例规格与副本数；</li>
<li>设定 HPA（K8s Horizontal Pod Autoscaler）策略：根据 CPU、内存或自定义指标（如请求延迟、队列长度）自动扩容。</li>
</ul>
</li>
<li>
<p><strong>弹性伸缩</strong>：</p>
<ul>
<li>Kubernetes Pod 伸缩；</li>
<li>数据库读副本扩容；Elasticsearch 节点扩容；Kafka partition 扩容（需平衡 rebalancing 时影响）。</li>
</ul>
</li>
<li>
<p><strong>成本优化</strong>：</p>
<ul>
<li>非高峰期可缩小实例；利用 Spot 实例处理异步任务；</li>
<li>评估 Managed Service（RDS/ElastiCache/ES Service）与自托管成本对比。</li>
</ul>
</li>
</ul>
<hr>
<h2 id="20-业务监测与优化">
  20. 业务监测与优化
  <a class="anchor" href="#20-%e4%b8%9a%e5%8a%a1%e7%9b%91%e6%b5%8b%e4%b8%8e%e4%bc%98%e5%8c%96">#</a>
</h2>
<ul>
<li>
<p><strong>关键指标 (KPI)</strong></p>
<ul>
<li>搜索响应时延、成功率；</li>
<li>预约成功率、冲突重试率；</li>
<li>预约取消率、改期率；</li>
<li>系统可用率、错误率、系统负载；</li>
<li>用户留存、使用频次（结合 Analytics）。</li>
</ul>
</li>
<li>
<p><strong>A/B 测试</strong></p>
<ul>
<li>对搜索排序算法（如距离优先 vs 评分优先）、时段推荐逻辑等进行实验，评估用户转化率。</li>
</ul>
</li>
<li>
<p><strong>机器学习 / 智能推荐（可选）</strong></p>
<ul>
<li>基于用户历史、地理位置、评价等，为用户推荐合适从业者；</li>
<li>但此功能与基础系统解耦，作为后续优化模块，通过独立服务调用搜索结果。</li>
</ul>
</li>
</ul>
<hr>
<h2 id="21-总结">
  21. 总结
  <a class="anchor" href="#21-%e6%80%bb%e7%bb%93">#</a>
</h2>
<ul>
<li><strong>微服务架构</strong>配合<strong>Kubernetes</strong>提供弹性、高可用和易部署；</li>
<li><strong>Go</strong> 或 <strong>Kotlin/Java</strong> 作为核心服务语言，满足高并发和生态需求；</li>
<li><strong>PostgreSQL/CockroachDB</strong> 作为关系型主库，按国家或分区部署，保证事务一致性；</li>
<li><strong>Elasticsearch</strong> 作为搜索引擎，支持地理和属性过滤，近实时索引更新；</li>
<li><strong>Redis</strong> 作为缓存与分布式锁，提升读取性能与并发控制；</li>
<li><strong>Kafka</strong> 作为事件总线，解耦异步任务（索引更新、通知、分析）；</li>
<li><strong>CI/CD + IaC</strong> 实现自动化、高效上线与可复制多国家部署；</li>
<li><strong>监控/Tracing/日志</strong>确保可观察性与故障定位；</li>
<li><strong>安全与合规</strong>贯穿设计，保护用户隐私并满足法规要求；</li>
<li><strong>可扩展性设计</strong>：按国家分库、分区，水平扩容服务实例，自动伸缩；</li>
<li><strong>一致性策略</strong>：预约采用单分区事务或分布式锁+Saga，搜索结果采用近实时弱一致。</li>
</ul>
<p>该方案避免单体架构，将功能拆分到独立微服务，便于团队并行迭代与扩展；同时通过异步事件驱动保持各组件解耦、近实时同步。多区域、多国家上线通过配置中心和 IaC 自动化支撑，降低运维复杂度。整体技术栈选型主流成熟、社区活跃，且各组件之间契约清晰、易于维护。通过严格的监控、测试和自动化部署，保证生产环境中系统的稳定、可用和可观测。</p>
</div>
</article>
 
      

      <footer class="book-footer">
        
  <div class="flex flex-wrap justify-between">



</div>



  <script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script>



<div class="busuanzi-footer">
  <p>© 2025 Powered By <a href="https://themes.gohugo.io/">Hugo</a> & 
    <a href="https://github.com/alex-shpak/hugo-book">Hugo-book</a> Contact: <a href="mailto:j.duan@foxmail.com">j.duan@foxmail.com</a></p> 
  <span id="busuanzi_container_site_pv">
    本站总访问量<span id="busuanzi_value_site_pv"></span>次
  </span>
  <span id="busuanzi_container_site_uv">
    本站访客数<span id="busuanzi_value_site_uv"></span>人次
  </span>
</div>
 
        
      </footer>

      
  
  <div class="book-comments">

</div>
  
 

      <label for="menu-control" class="hidden book-menu-overlay"></label>
    </div>

    
    <aside class="book-toc">
      <div class="book-toc-content">
        
  
<style>
    .no-marker::marker {
        content: none;
    }
</style>
<li class="no-marker"><a href="#Doctolib%20%e7%b3%bb%e7%bb%9f%e8%ae%be%e8%ae%a1">Doctolib 系统设计</a></li>
<nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#1-非功能需求与业务规模">1. 非功能需求与业务规模</a></li>
        <li><a href="#2-总体架构概览">2. 总体架构概览</a></li>
        <li><a href="#3-api-gateway-与服务通信">3. API Gateway 与服务通信</a></li>
        <li><a href="#4-身份认证与授权">4. 身份认证与授权</a></li>
        <li><a href="#5-数据存储方案">5. 数据存储方案</a>
          <ul>
            <li><a href="#51-关系型数据库主数据与事务">5.1 关系型数据库（主数据与事务）</a></li>
            <li><a href="#52-搜索索引全文与属性检索">5.2 搜索索引（全文与属性检索）</a></li>
            <li><a href="#53-缓存层">5.3 缓存层</a></li>
            <li><a href="#54-消息与事件总线">5.4 消息与事件总线</a></li>
          </ul>
        </li>
        <li><a href="#6-搜索流程设计">6. 搜索流程设计</a></li>
        <li><a href="#7-可用时段availability设计">7. 可用时段（Availability）设计</a>
          <ul>
            <li><a href="#71-概念模型">7.1 概念模型</a></li>
            <li><a href="#72-存储与计算">7.2 存储与计算</a></li>
          </ul>
        </li>
        <li><a href="#8-预约booking设计">8. 预约（Booking）设计</a>
          <ul>
            <li><a href="#81-业务流程">8.1 业务流程</a></li>
            <li><a href="#82-并发与一致性">8.2 并发与一致性</a></li>
          </ul>
        </li>
        <li><a href="#9-异步任务与事件驱动">9. 异步任务与事件驱动</a></li>
        <li><a href="#10-缓存与限流">10. 缓存与限流</a></li>
        <li><a href="#11-多区域与国际化">11. 多区域与国际化</a></li>
        <li><a href="#12-安全与合规">12. 安全与合规</a></li>
        <li><a href="#13-监控与可观察性">13. 监控与可观察性</a></li>
        <li><a href="#14-cicd-与自动化">14. CI/CD 与自动化</a></li>
        <li><a href="#15-测试策略">15. 测试策略</a></li>
        <li><a href="#16-技术选型小结与理由">16. 技术选型小结与理由</a></li>
        <li><a href="#17-多国家上线流程示例">17. 多国家上线流程示例</a></li>
        <li><a href="#18-容错与降级设计">18. 容错与降级设计</a></li>
        <li><a href="#19-监控扩容规划">19. 监控扩容规划</a></li>
        <li><a href="#20-业务监测与优化">20. 业务监测与优化</a></li>
        <li><a href="#21-总结">21. 总结</a></li>
      </ul>
    </li>
  </ul>
</nav>


 
      </div>
    </aside>
    
  </main>

  
</body>
</html>












